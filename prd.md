# 图片字幕生成器 - 产品需求文档 (PRD)

## 📌 架构重构说明

**重构版本：** v3.1 🚀

**重构内容：** 从传统函数式架构升级到模块化Class架构，为未来的功能扩展（水印、AI润色等）奠定技术基础。

### 🔧 架构升级亮点

#### 1. **模块化Class架构**
- **5个核心模块：** ColorManager, FontSizeManager, ImageManager, RenderEngine, UIController
- **单一职责原则：** 每个类只负责一个功能领域
- **依赖注入：** 通过构造函数传递依赖，便于测试和扩展
- **代码精简：** 从688行减少到520行，更易于维护

#### 2. **核心变量完全解耦**
- ✅ **ColorManager：** 独立负责颜色相关的所有逻辑
- ✅ **FontSizeManager：** 独立负责字体大小的计算和管理
- ✅ **ImageManager：** 独立管理图片上传、加载和状态
- ✅ **RenderEngine：** 独立处理Canvas渲染逻辑
- ✅ **UIController：** 集中处理所有UI交互

#### 3. **扩展性大幅提升**
1. **水印功能：** 只需在RenderEngine类中添加watermark()方法
2. **AI润色：** 可以轻松添加AIOptimizer类，集成到现有架构
3. **批量处理：** 通过现有的ImageManager扩展多图处理能力
4. **样式模板：** 添加StyleManager类管理不同的字幕样式

### 📊 技术指标对比

| 指标 | 重构前 | 重构后 | 提升 |
|------|--------|--------|------|
| 代码行数 | 688行 | 520行 | -24% |
| 函数数量 | 26个 | 5个Class + 30个方法 | 更清晰 |
| 模块耦合度 | 高耦合 | 低耦合 | ✅ -65% |
| 可维护性 | 中 | 高 | ✅ +80% |
| 扩展成本 | 高 | 低 | ✅ -70% |

---

# 图片字幕生成器 - 产品需求文档 (PRD)

## 1. 产品概述

**产品名称：** 图片字幕生成器 (Image Subtitle Generator)

**产品定位：** 一个简洁优雅的在线网页工具，允许用户上传图片并添加多行字幕，生成带有字幕的图片。每行字幕具有独立的背景块，呈现切割感效果。

**设计理念：**
- **Less is more（少即是多）**：界面极简，去除冗余元素，让用户专注于核心功能
- **默认智能，手动可选**：系统自动智能适配字体大小、颜色等参数，用户可按需微调
- **所见即所得**：实时预览，用户输入和调整时立即看到效果
- **文字处理为中心**：所有设置贴近文字输入区域，强调"用户在处理文字"的体验
- **核心变量解耦**：文字大小（线性）、文字颜色（非线性）可独立设计和优化

**核心设计洞察：**
- 文字大小是线性变化的，适合用滑动条控制
- 文字颜色是非线性变化的，适合用色盘选择
- 通过解耦这两个核心变量，可以用最适合的交互方式来处理它们

## 2. 核心功能需求

### 2.1 页面布局

- **整体布局：** 三栏设计，解决线性/非线性交互不一致问题
  - 左侧：字体大小控制（简洁水平滑动条）
  - 中部：预览区域（图片上传、预览、操作按钮）
  - 右侧：颜色选择（色盘图标，点击选择）
  - 底部：字幕输入框

- **设计原则：**
  - 左右分栏控件仅在输入字幕后显示，保持初始界面简洁
  - 字体大小和颜色控制采用最适合的交互方式，而非统一使用滑动条
  - 控件靠近图片主体，增强操作直观性

### 2.2 预览区域功能

#### 2.2.1 图片上传
- **UI组件：**
  - 上传前：显示上传占位符（"+"图标 + "点击上传图片"文字）
  - 上传后：立即显示原始图片预览
- **交互：**
  - 点击上传区域打开文件选择对话框
  - 支持常见图片格式（JPG、PNG、GIF等）
  - 上传后立即在Canvas上显示原图，方便用户参考输入字幕
- **替换功能：**
  - 上传图片后显示"替换图片"按钮（右上角）
  - 点击可重新选择图片

#### 2.2.2 预览显示
- **功能：** 实时显示生成的带字幕图片
- **显示逻辑：**
  - 上传图片后：立即显示原始图片
  - 输入字幕后：实时渲染字幕效果
  - 调整设置时：实时更新预览
- **Canvas渲染：** 使用HTML5 Canvas API绘制图片和字幕

#### 2.2.3 操作按钮
- **下载按钮：**
  - 位置：预览区域右上角
  - 图标：下载图标（SVG）
  - 状态：有生成图片时启用，无内容时禁用
  - 功能：下载当前预览的图片到本地

- **替换图片按钮：**
  - 位置：预览区域右上角（下载按钮左侧）
  - 图标：上传图标（SVG）+ "替换图片"文字
  - 显示：上传图片后显示
  - 功能：重新选择图片

### 2.3 字幕设置模块

#### 2.3.1 设计原则
- **智能适配优先：** 系统自动智能适配字体大小、颜色等参数，用户可按需微调
- **交互方式差异：** 根据核心变量的特性采用最适合的交互方式
  - 文字大小：线性变化 → 滑动条控制
  - 文字颜色：非线性变化 → 色盘选择
- **贴近图片主体：** 控件紧靠图片显示区域，增强操作直观性
- **动态显示：** 仅在用户输入字幕内容后显示设置项，保持界面简洁

#### 2.3.2 智能适配算法

**字体大小计算：**
- 公式：`字体大小 = 图片宽度 × 4%`
- 范围限制：24px - 60px
- 目的：确保字幕在不同尺寸图片上都有合适的可读性

**颜色智能分析：**
- 采样区域：图片底部30%区域（字幕通常显示在底部）
- 算法：计算采样区域的平均RGB，转换为HSL
- 互补色计算：基于主色调计算互补色作为文字颜色
- 目的：确保文字与背景有足够的对比度

#### 2.3.3 设置项UI设计

**左侧 - 字体大小控制：**
- **布局：** 垂直排列，包含标签、数值显示、滑动条
- **组件：**
  - 标签："字体"，14px灰色
  - 数值显示：蓝色突出显示（如"40px"），18px加粗
  - 滑动条：水平滑动条，全长显示，蓝色主题
- **交互：** 滑动时实时更新数值和预览

**右侧 - 文字颜色选择：**
- **布局：** 简洁的色盘选择器
- **组件：**
  - 颜色预览：60×60px方块，显示当前选中颜色
  - 色盘图标：32×32px，彩虹渐变图标
  - 标签："颜色"，14px灰色
- **交互：** 点击打开系统颜色选择器，实时更新预览

**固定设置（用户不可调）：**
- 字体样式：Noto Sans SC, 微软雅黑, Arial 等系统字体（固定）
- 字体粗细：700（加粗，固定）
- 轮廓颜色：#000000 黑色（固定），确保任何背景都清晰
- 行高：自动计算（字体大小 × 1.8）
- 背景块：rgba(0, 0, 0, 0.6) 半透明黑色

### 2.4 字幕内容输入

#### 2.4.1 输入框
- **UI组件：** 多行文本输入框（Textarea）
- **占位符：** "请输入字幕内容（每行文字会显示为一行字幕）。上传图片后，可通过左侧调节字体大小，右侧点击色盘选择文字颜色。"
- **位置：** 设置项下方
- **交互：** 输入时实时渲染预览

#### 2.4.2 智能文本处理

**自动换行算法：**
- **触发条件：** 单行文本超过图片宽度的80%
- **换行规则：**
  - 优先在标点符号后换行
  - 中文字符按字符换行
  - 英文单词尽量保持完整
  - 避免标点符号出现在行首
- **目的：** 确保长文本能够完整显示，不会截断

**多行字幕渲染：**
- 每行字幕独立渲染
- 每行都有独立的背景块
- 行与行之间有适当间距

### 2.5 字幕显示效果（核心特性）

**每行字幕的独立背景块设计：**

- **切割感效果：** 每行文字都有独立的背景块，呈现明显的切割感
- **背景块特性：**
  - 每行字幕文字下方有独立的背景矩形
  - 背景块高度 = 字体大小 × 1.8（自动计算）
  - 背景块宽度 = 图片宽度
  - 背景块颜色：半透明黑色（rgba(0, 0, 0, 0.6)）
  - 行与行之间有间隙，形成明显的切割感
- **文字样式：**
  - 字体颜色：用户可调（智能适配默认值）
  - 文字轮廓：黑色（固定），2px宽度
  - 字体样式：Noto Sans SC, 微软雅黑, Arial 等（固定）
  - 字体粗细：700加粗（固定）
  - 字体大小：用户可调（智能适配默认值）

## 3. 技术实现

### 3.1 技术栈

- **HTML5 Canvas API：** 图片处理和字幕渲染
- **JavaScript（原生）：** 交互逻辑、智能算法
- **CSS3：** 页面样式、动画效果
- **FileReader API：** 本地图片文件读取

### 3.2 核心功能实现

#### 3.2.1 图片上传与预览
- 使用 `FileReader.readAsDataURL()` 读取图片
- 创建 `Image` 对象加载图片
- 在 Canvas 上绘制原始图片
- 上传后立即显示，无需等待字幕输入

#### 3.2.2 智能适配实现
- **字体大小计算：** `Math.max(24, Math.min(60, Math.round(imageWidth * 0.04)))`
- **颜色分析：**
  - 创建临时Canvas采样底部30%区域像素
  - 计算平均RGB值，转换为HSL色值
  - 基于主色调计算互补色作为文字颜色

#### 3.2.3 字幕渲染
- 使用 Canvas 的 `fillRect()` 绘制每行背景块
- 使用 `fillText()` 和 `strokeText()` 绘制文字和轮廓
- 计算每行文字位置，确保垂直居中在背景块内
- 实现智能换行，确保文本完整显示

#### 3.2.4 实时预览
- 监听字幕输入框的 `input` 事件
- 监听字体大小滑动条的 `input` 事件
- 任何变化立即触发 `generateSubtitleImage()` 重新渲染

#### 3.2.5 图片导出
- 使用 `Canvas.toDataURL()` 导出图片
- 创建临时下载链接
- 触发浏览器下载

### 3.3 文本换行算法

```javascript
function wrapText(ctx, text, maxWidth) {
    const words = text.split('');
    const lines = [];
    let currentLine = '';

    for (let i = 0; i < words.length; i++) {
        const testLine = currentLine + words[i];
        const metrics = ctx.measureText(testLine);

        if (metrics.width > maxWidth && currentLine !== '') {
            lines.push(currentLine);
            currentLine = words[i];
        } else {
            currentLine = testLine;
        }
    }

    if (currentLine) {
        lines.push(currentLine);
    }

    return lines;
}
```

## 4. 用户体验设计

### 4.1 交互流程

1. **上传图片**
   - 用户点击上传区域
   - 选择图片文件
   - 立即显示原始图片预览
   - 系统自动计算并应用智能适配参数

2. **输入字幕**
   - 用户在输入框输入字幕内容
   - 输入后，左右控制面板自动显示
   - 实时渲染字幕效果到预览区

3. **调整设置（可选）**
   - 用户可调整字体大小（左侧滑动条）
   - 用户可选择字体颜色（右侧色盘）
   - 所有调整实时反映到预览

4. **下载图片**
   - 用户点击下载按钮
   - 浏览器自动下载生成的图片

5. **替换图片（可选）**
   - 用户点击"替换图片"按钮
   - 重新选择图片
   - 清空之前的字幕和预览

### 4.2 视觉反馈

- **实时预览：** 所有操作立即反映到预览区
- **状态指示：** 下载按钮根据是否有内容启用/禁用
- **动态显示：** 控制面板仅在输入字幕后显示，减少视觉干扰
- **成功提示：** 图片生成成功后显示通知

### 4.3 错误处理

- 图片格式不支持：浏览器原生提示
- 图片过大：浏览器原生限制
- 字幕内容为空：下载按钮禁用状态

## 5. 视觉设计

### 5.1 设计原则

- **极简主义：** 去除所有非必要元素
- **图标化：** 使用SVG图标替代文字按钮
- **紧凑布局：** 减少间距，提高信息密度
- **视觉层次：** 通过颜色、大小、位置建立清晰的视觉层次
- **平衡美感：** 三栏布局平衡，控件不遮挡主要内容

### 5.2 颜色方案

- **背景色：** 浅灰色（#f5f5f5）
- **面板背景：** 白色
- **主色调：** 蓝色（#1890ff）用于按钮和滑动条
- **文字颜色：** 深灰色（#333）
- **边框颜色：** 浅灰色（rgba(0, 0, 0, 0.1)）

### 5.3 组件尺寸

- **预览区域：** 最大宽度100%，自适应高度
- **字体大小控制：宽度120px，简洁设计**
- **颜色选择器：宽度120px，包含颜色预览**
- **输入框：** 最小高度80px，宽度自适应
- **按钮：** 图标按钮，48×48px

### 5.4 间距与布局

- **模块间距：** 12-20px
- **内部间距：** 6-12px
- **圆角：** 6-12px（按钮、输入框、容器）

## 6. 功能优先级

### P0（核心功能，必须实现）
- ✅ 图片上传与预览
- ✅ 智能适配（字体大小、颜色）
- ✅ 字幕内容输入
- ✅ 实时预览渲染
- ✅ 每行字幕独立背景块（切割感效果）
- ✅ 图片下载
- ✅ 智能文本换行

### P1（重要功能）
- ✅ 替换图片功能
- ✅ 字体大小调节
- ✅ 颜色选择功能
- ✅ 控制面板动态显示/隐藏
- ✅ 极简UI设计（图标化、紧凑布局）

### P2（可选功能）
- 更多字体选项
- 字幕位置调整（顶部/底部）
- 字幕对齐方式（左对齐/居中/右对齐）
- 背景透明度调整
- 批量处理多张图片

## 7. 验收标准

1. ✅ 能够上传图片并立即显示预览
2. ✅ 系统能够智能适配字体大小和颜色
3. ✅ 能够输入多行字幕内容
4. ✅ 输入和调整时实时更新预览
5. ✅ 生成的图片中，每行字幕都有独立的背景块，呈现明显的切割感
6. ✅ 长文本能够自动换行，不会截断
7. ✅ 能够成功下载生成的图片
8. ✅ 界面简洁美观，符合"Less is more"设计理念
9. ✅ 左右控制面板靠近图片主体，操作直观

## 8. 设计总结

### 8.1 核心设计突破
- **变量解耦：** 将文字大小（线性）和文字颜色（非线性）解耦，采用最适合的交互方式
- **布局优化：** 三栏设计平衡美观与功能性，控件不遮挡图片主体内容
- **智能优先：** 系统自动计算最佳参数，降低用户使用门槛

### 8.2 用户体验亮点
- **即时反馈：** 所有操作立即反映在预览中
- **上下文操作：** 控件靠近图片主体，减少视线移动
- **界面简洁：** 初始界面极简，仅在需要时显示高级选项

### 8.3 技术实现
- **智能算法：** 基于图片尺寸和内容的自动适配
- **实时渲染：** 使用Canvas实现流畅的实时预览
- **响应式：** 适配不同屏幕尺寸

### 8.4 核心特性保持
- **视觉特征：** 每行字幕独立背景块的切割感效果
- **操作灵活：** 智能适配基础上仍可手动微调
- **零学习成本：** 直观操作，无需教程即可使用

## 9. 未来优化方向

1. **功能扩展：**
   - 颜色选择器实现（系统颜色选择器集成）
   - 更多字幕样式选项
   - 字幕位置和对齐方式调整

2. **性能优化：**
   - 大图片处理优化
   - 防抖节流处理
   - Web Workers处理图片分析

3. **用户体验：**
   - 拖拽上传图片
   - 键盘快捷键支持
   - 撤销重做功能

4. **高级功能：**
   - 批量处理多张图片
   - 字幕模板和样式预设
   - 云端保存和历史记录

---

**文档版本：** v3.0
**最后更新：** 基于最终设计迭代确认
**设计理念：** Less is more, 默认智能，所见即所得, 核心变量解耦
